---
import Link from "@/components/atoms/link.astro";
import Prose from "@/components/atoms/prose.astro";
import { envVars } from "@/config/environment";
import ProjectLayout from "@/layouts/project.astro";
import type { GetStaticPaths } from "astro";
import { getCollection, getEntry, render } from "astro:content";

export const getStaticPaths = (async ({ paginate }) => {
  const entries = await getCollection("projects", ({ data }) => {
    const status = ["draft", "preview", "published"] as const;
    return (
      data.language === "en" &&
      (import.meta.env.MODE === "production"
        ? envVars.ENABLE_PREVIEW && data.status !== "draft"
          ? status.includes(data.status)
          : data.status === "published"
        : true)
    );
  });

  return paginate(entries, { pageSize: 1 });
}) satisfies GetStaticPaths;

const { page } = Astro.props;

const entry = page.data.at(0);
if (!entry) return Astro.rewrite("/404");

const [markdown, _author] = await Promise.all([
  render(entry),
  getEntry(entry.data.author),
]);

const { Content, remarkPluginFrontmatter } = markdown || {};

// update the collection schema with plugin data
entry.data.updatedAt ||= new Date(remarkPluginFrontmatter.updatedAt);
entry.data.duration ||= remarkPluginFrontmatter.duration;
entry.data.words ||= remarkPluginFrontmatter.words;
---

<ProjectLayout title="" description="" jsonld={{}}>
  <Prose>
    <h1 id="headline">{entry.data.title}</h1>
    <Content />
  </Prose>

  <div class="flex items-center gap-4">
    {page.url.prev ? <Link href={page.url.prev}>Previous</Link> : null}
    {page.url.next ? <Link href={page.url.next}>Next</Link> : null}
  </div>
</ProjectLayout>
