<x-like-button> </x-like-button>
<script>
  import { str_to_bool } from "@/helpers";
  import { controller, attr, target } from "@github/catalyst";
  import { actions } from "astro:actions";

  @controller // @ts-expect-error
  class XLikeButton extends HTMLElement {
    @attr liked = Boolean(localStorage.getItem("liked"));
    @attr slug = "";
    @attr pending = false;
    @target declare text: HTMLElement;

    async toggleLike() {
      this.liked = !str_to_bool(localStorage.getItem("liked"));

      if (this.liked) localStorage.setItem("liked", "true");
      else localStorage.removeItem("liked");

      const { error } = await actions.like.safe({
        liked: this.liked,
        slug: this.slug,
      });

      if (error) {
        this.text.textContent =
          error.code === "TOO_MANY_REQUESTS"
            ? "Slow down! Rate limited you for the day"
            : "Oops, failed to update likes";

        return;
      }
    }
  }
</script>
